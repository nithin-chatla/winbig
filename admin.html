<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - WinBig</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf-autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #4f46e5; --primary-hover: #4338ca; --secondary-bg: #f8fafc;
            --border-color: #e2e8f0; --text-dark: #1e293b; --text-light: #64748b;
            --danger-color: #ef4444; --danger-hover: #dc2626; --success-color: #22c55e;
            --success-hover: #16a34a; --warning-color: #f59e0b; --warning-hover: #d97706;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--secondary-bg); color: var(--text-dark); margin: 0; }
        nav { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-bottom: 1px solid var(--border-color); }
        nav .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        main { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        .container { background-color: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid var(--border-color); margin-bottom: 2rem; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; }
        h2, h3 { color: var(--text-dark); text-align: center; margin-top: 0; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
        button { padding: 0.75rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.9rem; margin: 0 0.2rem; }
        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-warning:hover { background-color: var(--warning-hover); transform: translateY(-2px); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover); transform: translateY(-2px); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: var(--success-hover); transform: translateY(-2px); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .stat-card { text-align: center; }
        .stat-card .value { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); min-height: 48px; }
        .stat-card .label { font-size: 1rem; font-weight: 500; color: var(--text-light); }
        .loader { border: 4px solid #e2e8f0; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .centered-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        #admin-panel-view { display: none; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; display: block; overflow-x: auto; white-space: nowrap; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle;}
        .payment-input { width: 80px; text-align: right; margin-right: 0.5rem; }
        .status-badge { padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .status-active { background-color: #dcfce7; color: #166534; }
        .status-inactive { background-color: #fee2e2; color: #991b1b; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 2rem; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 8px; position: relative; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .message { display:none; padding: 1rem; text-align: center; border-radius: 6px; margin-top: 1rem;}
        .error { background-color: #fee2e2; color: #991b1b; }
        .success { background-color: #dcfce7; color: #166534; }
        .back-btn { margin-bottom: 1rem; }
        #printable-tickets-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto; background: #f8fafc; padding: 1rem; border-radius: 6px; }
        .ticket-stub { border: 1px solid var(--border-color); padding: 0.5rem; text-align: center; font-weight: 600; border-radius: 4px; }
        .form-group { position: relative; }
        .form-input { 
            padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border-color); width: 100%; box-sizing: border-box; 
            font-size: 1rem; font-family: 'Inter', sans-serif; background-color: white;
        }
        .form-label {
            position: absolute; left: 0.75rem; top: 0.75rem; color: var(--text-light);
            pointer-events: none; transition: all 0.2s ease;
        }
        .form-input:focus + .form-label, .form-input:not(:placeholder-shown) + .form-label {
            top: -0.6rem; left: 0.5rem; font-size: 0.75rem; color: var(--primary-color);
            background-color: white; padding: 0 0.25rem;
        }
        input[type="file"] { padding: 0; }
        input[type="file"]::file-selector-button {
            background-color: var(--primary-color); color: white; border: none;
            padding: 0.75rem; border-radius: 6px 0 0 6px; cursor: pointer;
            margin-right: 1rem; transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover { background-color: var(--primary-hover); }

        @media (max-width: 768px) {
            main { padding: 1rem; }
            nav { flex-direction: column; gap: 0.5rem; padding: 1rem; }
            .section-header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>

    <div id="login-view" class="centered-container">
        <div class="container" style="max-width: 400px;">
            <h2>Admin Login</h2>
            <form id="login-form" class="space-y-6">
                <div class="form-group">
                    <input type="text" id="admin-username" class="form-input" placeholder=" " required>
                    <label for="admin-username" class="form-label">Username</label>
                </div>
                <div class="form-group">
                    <input type="password" id="admin-password" class="form-input" placeholder=" " required>
                    <label for="admin-password" class="form-label">Password</label>
                </div>
                <button type="submit" class="w-full btn-primary">Login</button>
            </form>
            <div id="login-message" class="message"></div>
        </div>
    </div>

    <div id="admin-panel-view">
        <nav>
            <div class="logo">WinBig ADMIN</div>
            <div>
                <a href="./index.html" target="_blank" class="text-gray-600 hover:text-indigo-600">Public Site</a>
                <a href="./agent.html" target="_blank" style="margin: 0 1rem;" class="text-gray-600 hover:text-indigo-600">Agent Panel</a>
                <button id="logout-btn" style="background:none; border:none; color: var(--text-light); cursor:pointer;">Logout</button>
            </div>
        </nav>
        
        <main>
            <div class="container stats-grid">
                 <div class="stat-card"><div id="total-revenue" class="value">₹0</div><div class="label">Total Revenue</div></div>
                 <div class="stat-card"><div id="adjusted-profit" class="value">₹0</div><div class="label">Adjusted Profit</div></div>
                 <div class="stat-card"><div id="balance-due" class="value">₹0</div><div class="label">Balance Due From Agents</div></div>
                 <div class="stat-card"><div id="total-tickets" class="value">0</div><div class="label">Tickets Sold</div></div>
            </div>

            <div id="message-container"></div>

            <div class="container">
                <h2>Website Content Management (CMS)</h2>
                <form id="cms-form" class="mt-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold text-lg mb-2">Homepage</h3>
                            <div class="space-y-6">
                                <div class="form-group"><input type="text" id="cms-home_hero_title" class="form-input" placeholder=" "><label class="form-label">Hero Title</label></div>
                                <div class="form-group"><textarea id="cms-home_hero_subtitle" rows="3" class="form-input" placeholder=" "></textarea><label class="form-label">Hero Subtitle</label></div>
                                <div class="form-group"><input type="text" id="cms-home_howitworks_title" class="form-input" placeholder=" "><label class="form-label">"How It Works" Title</label></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg mb-2">Other Pages</h3>
                            <div class="space-y-6">
                                <div class="form-group"><input type="text" id="cms-events_page_title" class="form-input" placeholder=" "><label class="form-label">Events Page Title</label></div>
                                <div class="form-group"><input type="text" id="cms-gallery_page_title" class="form-input" placeholder=" "><label class="form-label">Gallery Page Title</label></div>
                                <div class="form-group"><input type="text" id="cms-winners_page_title" class="form-input" placeholder=" "><label class="form-label">Winners Page Title</label></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <button type="submit" class="btn-success">Save Website Content</button>
                    </div>
                </form>
            </div>


            <div class="container">
                <h2>Content Management</h2>
                <div class="grid-container">
                    <div>
                        <h3>Add a Past Winner</h3>
                        <form id="add-winner-form" class="space-y-6 mt-4">
                            <div class="form-group"><input type="text" id="winner-name" class="form-input" placeholder=" " required><label class="form-label">Winner's Name</label></div>
                            <div class="form-group"><input type="text" id="winner-prize" class="form-input" placeholder=" " required><label class="form-label">Prize Won</label></div>
                            <div class="form-group"><textarea id="winner-testimonial" rows="2" class="form-input" placeholder=" "></textarea><label class="form-label">Winner's Testimonial</label></div>
                            <input type="file" id="winner-photo" accept="image/*" required>
                            <button type="submit" class="btn-primary">Add Winner</button>
                        </form>
                    </div>
                    <div>
                        <h3>Add to Prize Gallery</h3>
                        <form id="add-gallery-form" class="space-y-6 mt-4">
                            <div class="form-group"><input type="text" id="gallery-description" class="form-input" placeholder=" " required><label class="form-label">Image Description</label></div>
                            <input type="file" id="gallery-image" accept="image/*" required>
                            <button type="submit" class="btn-primary">Upload to Gallery</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="container">
                <div class="section-header">
                    <h2>Manage Lotteries</h2>
                    <button class="btn-sm btn-success export-pdf-btn" data-table="manage-lotteries-list" data-title="Lottery List">Export PDF</button>
                </div>
                <div id="manage-lotteries-list"><div class="loader"></div></div>
            </div>

            <div class="container">
                <div class="section-header">
                    <h2>Daily Revenue Report</h2>
                    <button class="btn-sm btn-success export-pdf-btn" data-table="daily-revenue-list" data-title="Daily Revenue Report">Export PDF</button>
                </div>
                <div id="daily-revenue-list"><div class="loader"></div></div>
            </div>

            <div class="grid-container">
                 <div class="container">
                    <h2>Record a Withdrawal</h2>
                    <form id="withdrawal-form" class="space-y-6">
                        <div class="form-group"><input type="number" id="withdrawal-amount" class="form-input" placeholder=" " required><label class="form-label">Amount (₹)</label></div>
                        <div class="form-group"><input type="text" id="withdrawal-desc" class="form-input" placeholder=" " required><label class="form-label">Description</label></div>
                        <button type="submit" class="btn-primary">Record Withdrawal</button>
                    </form>
                </div>
                <div class="container">
                    <div class="section-header">
                        <h2>Withdrawal History</h2>
                        <button class="btn-sm btn-success export-pdf-btn" data-table="withdrawal-history-list" data-title="Withdrawal History">Export PDF</button>
                    </div>
                    <div id="withdrawal-history-list"><div class="loader"></div></div>
                </div>
            </div>
             <div class="grid-container">
                 <div class="container">
                    <h2>Add Revenue Adjustment</h2>
                    <form id="adjustment-form" class="space-y-6">
                        <div class="form-group"><input type="number" id="adjustment-amount" class="form-input" placeholder=" " required><label class="form-label">Amount (₹)</label></div>
                        <div class="form-group"><input type="text" id="adjustment-desc" class="form-input" placeholder=" " required><label class="form-label">Description</label></div>
                        <button type="submit" class="btn-primary">Add Adjustment</button>
                    </form>
                </div>
                <div class="container">
                    <div class="section-header">
                        <h2>Adjustment History</h2>
                        <button class="btn-sm btn-success export-pdf-btn" data-table="adjustment-history-list" data-title="Adjustment History">Export PDF</button>
                    </div>
                    <div id="adjustment-history-list"><div class="loader"></div></div>
                </div>
            </div>

            <div class="container">
                 <div class="section-header">
                    <h2>Manage Agents</h2>
                    <button class="btn-sm btn-success export-pdf-btn" data-table="manage-agents-list" data-title="Agent List">Export PDF</button>
                </div>
                <div id="manage-agents-list"><div class="loader"></div></div>
            </div>
            <div class="container">
                <div class="section-header">
                    <h2 id="agent-performance-title">Agent Performance</h2>
                    <button class="btn-sm btn-success export-pdf-btn" data-table="agent-performance-list" data-title="Agent Performance Report">Export PDF</button>
                </div>
                <div id="agent-performance-controls">
                    <div class="form-group"><input type="text" id="agent-search-input" class="form-input" placeholder=" "><label class="form-label">Search Agents...</label></div>
                </div>
                <div id="agent-performance-list"><div class="loader"></div></div>
            </div>
            <div class="container">
                <div class="section-header">
                    <h2>All Participants</h2>
                    <button class="btn-sm btn-success export-pdf-btn" data-table="all-participants-list" data-title="All Participants">Export PDF</button>
                </div>
                <div class="form-group"><input type="text" id="participant-search-input" class="form-input" placeholder=" "><label class="form-label">Search Participants...</label></div>
                <div id="all-participants-list"><div class="loader"></div></div>
            </div>
            <div class="grid-container">
                <div class="container">
                    <h2>Create New Lottery</h2>
                    <form id="create-lottery-form" class="space-y-6">
                        <div class="form-group"><input type="text" id="prize-name" class="form-input" placeholder=" " required><label class="form-label">Prize Name</label></div>
                        <div class="form-group"><input type="text" id="lottery-prefix" class="form-input" placeholder=" " required><label class="form-label">Serial Prefix (e.g. LOT1)</label></div>
                        <div class="form-group"><input type="number" id="ticket-price" class="form-input" placeholder=" " required><label class="form-label">Ticket Price (₹)</label></div>
                        <div class="form-group"><input type="date" id="draw-date" class="form-input" placeholder=" " required><label class="form-label">Draw Date</label></div>
                        <div class="form-group"><input type="text" id="draw-place" class="form-input" placeholder=" "><label class="form-label">Draw Location</label></div>
                        <div class="form-group"><textarea id="process-details" rows="2" class="form-input" placeholder=" "></textarea><label class="form-label">Process Details</label></div>
                        <input type="file" id="lottery-image" accept="image/*" required>
                        <button type="submit" class="btn-primary">Create Lottery</button>
                    </form>
                </div>
                <div class="container">
                    <h2>Create New Agent</h2>
                    <form id="create-agent-form" class="space-y-6">
                        <div class="form-group"><input type="text" id="agent-name" class="form-input" placeholder=" " required><label class="form-label">Agent Full Name</label></div>
                        <div class="form-group"><input type="tel" id="agent-phone" class="form-input" placeholder=" " required><label class="form-label">Agent Phone</label></div>
                        <div class="form-group"><input type="password" id="agent-password" class="form-input" placeholder=" " required><label class="form-label">Create Password</label></div>
                        <input type="file" id="agent-photo" accept="image/*" required>
                        <button type="submit" class="btn-primary">Create Agent</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="edit-lottery-modal" class="modal"> <div class="modal-content" style="max-width: 500px;"> <span class="close-btn" data-modal="edit-lottery-modal">&times;</span> <h2>Edit Lottery</h2> <form id="edit-lottery-form" class="space-y-4"> <input type="hidden" id="edit-lottery-id"> <div class="form-group"><input type="text" id="edit-prize-name" class="form-input" placeholder=" " required><label class="form-label">Prize Name</label></div> <div class="form-group"><input type="text" id="edit-lottery-prefix" class="form-input" placeholder=" " required><label class="form-label">Serial Prefix</label></div> <div class="form-group"><input type="number" id="edit-ticket-price" class="form-input" placeholder=" " required><label class="form-label">Ticket Price (₹)</label></div> <div class="form-group"><input type="date" id="edit-draw-date" class="form-input" placeholder=" " required><label class="form-label">Draw Date</label></div> <div class="form-group"><input type="text" id="edit-draw-place" class="form-input" placeholder=" "><label class="form-label">Draw Location</label></div> <div class="form-group"><textarea id="edit-process-details" rows="2" class="form-input" placeholder=" "></textarea><label class="form-label">Process Details</label></div> <div><label class="block text-sm font-medium mb-1">Update Image (Optional)</label><input type="file" id="edit-lottery-image" accept="image/*"></div> <div id="winner-assignment-section" style="display:none;" class="pt-4 mt-4 border-t"> <h3 class="font-semibold text-lg mb-2">Assign Winner</h3> <div class="form-group"><select id="edit-lottery-winner" class="form-input"></select><label class="form-label">Select Winner</label></div> <div class="form-group"><input type="text" id="edit-winner-ticket-id" class="form-input" placeholder=" "><label class="form-label">Winning Ticket ID</label></div> </div> <button type="submit" class="btn-primary">Save Changes</button> </form> </div> </div>
    <div id="edit-agent-modal" class="modal"> <div class="modal-content" style="max-width: 500px;"> <span class="close-btn" data-modal="edit-agent-modal">&times;</span> <h2>Edit Agent</h2> <form id="edit-agent-form" class="space-y-4"> <input type="hidden" id="edit-agent-id"> <div class="form-group"><input type="text" id="edit-agent-name" class="form-input" placeholder=" " required><label class="form-label">Agent Name</label></div> <div class="form-group"><input type="tel" id="edit-agent-phone" class="form-input" placeholder=" " required><label class="form-label">Agent Phone</label></div> <div class="form-group"><input type="text" id="edit-agent-password" class="form-input" placeholder=" "><label class="form-label">New Password (optional)</label></div> <div><label class="block text-sm font-medium mb-1">Update Photo (Optional)</label><input type="file" id="edit-agent-photo" accept="image/*"></div> <button type="submit" class="btn-primary">Save Changes</button> </form> </div> </div>
    <div id="view-participants-modal" class="modal"> <div class="modal-content"> <span class="close-btn" data-modal="view-participants-modal">&times;</span> <h2 id="participants-modal-title">Participants</h2> <div class="form-group"><input type="text" id="participants-modal-search" class="form-input" placeholder=" "><label class="form-label">Search Participants...</label></div> <div id="participants-modal-list"></div> </div> </div>
    <div id="edit-withdrawal-modal" class="modal"> <div class="modal-content" style="max-width: 500px;"> <span class="close-btn" data-modal="edit-withdrawal-modal">&times;</span> <h2>Edit Withdrawal</h2> <form id="edit-withdrawal-form" class="space-y-4"> <input type="hidden" id="edit-withdrawal-id"> <div class="form-group"><input type="number" id="edit-withdrawal-amount" class="form-input" placeholder=" " required><label class="form-label">Amount (₹)</label></div> <div class="form-group"><input type="text" id="edit-withdrawal-desc" class="form-input" placeholder=" " required><label class="form-label">Description</label></div> <button type="submit" class="btn-primary">Save Changes</button> </form> </div> </div>
    <div id="edit-adjustment-modal" class="modal"> <div class="modal-content" style="max-width: 500px;"> <span class="close-btn" data-modal="edit-adjustment-modal">&times;</span> <h2>Edit Adjustment</h2> <form id="edit-adjustment-form" class="space-y-4"> <input type="hidden" id="edit-adjustment-id"> <div class="form-group"><input type="number" id="edit-adjustment-amount" class="form-input" placeholder=" " required><label class="form-label">Amount (₹)</label></div> <div class="form-group"><input type="text" id="edit-adjustment-desc" class="form-input" placeholder=" " required><label class="form-label">Description</label></div> <button type="submit" class="btn-primary">Save Changes</button> </form> </div> </div>
    <div id="export-tickets-modal" class="modal"> <div class="modal-content"> <span class="close-btn" data-modal="export-tickets-modal">&times;</span> <div class="section-header"> <h2 id="export-tickets-modal-title">Lottery Tickets</h2> <button id="print-tickets-pdf-btn" class="btn-sm btn-success">Print PDF</button> </div> <div id="printable-tickets-grid"></div> </div> </div>
    <div id="confirmation-modal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h2 id="confirmation-modal-title">Are you sure?</h2>
            <p id="confirmation-modal-message" style="margin: 1.5rem 0;"></p>
            <div>
                <button id="confirmation-modal-confirm-btn" class="btn-danger" style="min-width: 100px; margin-right: 1rem;">Confirm</button>
                <button id="confirmation-modal-cancel-btn" class="btn-primary" style="min-width: 100px;">Cancel</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, query, where, serverTimestamp, deleteDoc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const CLOUDINARY_CLOUD_NAME = "dugnv4zww";
        const CLOUDINARY_UPLOAD_PRESET = "winbig_uploads";
        const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

        const firebaseConfig = {
            apiKey: "AIzaSyCP7extT3aBFU8Pzo95_zbmKviMGVRQt9E",
            authDomain: "winbig-83d30.firebaseapp.com",
            projectId: "winbig-83d30",
            storageBucket: "winbig-83d30.appspot.com",
            messagingSenderId: "752719565889",
            appId: "1:752719565889:web:9ff8c0768d9a01146ee2c0",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const loginView = document.getElementById('login-view');
        const adminPanelView = document.getElementById('admin-panel-view');
        const agentSearchInput = document.getElementById('agent-search-input');
        const participantSearchInput = document.getElementById('participant-search-input');
        const participantsModalSearch = document.getElementById('participants-modal-search');
        const confirmationModal = document.getElementById('confirmation-modal');

        let allAgents = new Map();
        let allLotteries = new Map();
        let allTickets = [];
        let allWithdrawals = [];
        let allAdjustments = [];
        let allWinners = [];
        let agentPerformanceData = {};
        let lotteryPerformanceData = {};
        let currentLotteryParticipants = [];
        let unsubscribes = [];
        let selectedAgentId = null;
        let selectedLotteryId = null;
        
        async function uploadImageToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            try {
                const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.secure_url) { return data.secure_url; } else { throw new Error('Image upload failed.'); }
            } catch (error) {
                console.error("Cloudinary Upload Error:", error);
                alert("Image upload failed. Check your Cloudinary Cloud Name and Upload Preset in the code.");
                return null;
            }
        }

        function setupRealtimeListeners() {
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];
            const collectionsToWatch = {
                agents: (data) => allAgents = new Map(data.map(item => [item.id, item])),
                lotteries: (data) => allLotteries = new Map(data.map(item => [item.id, item])),
                tickets: (data) => allTickets = data,
                withdrawals: (data) => allWithdrawals = data,
                adjustments: (data) => allAdjustments = data,
                winners: (data) => allWinners = data,
            };
            Object.entries(collectionsToWatch).forEach(([name, setter]) => {
                const unsub = onSnapshot(collection(db, name), (snapshot) => {
                    setter(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    rerenderDashboard();
                });
                unsubscribes.push(unsub);
            });
            const unsubContent = onSnapshot(doc(db, "site_content", "live_data"), (doc) => {
                if (doc.exists()) { populateCmsForm(doc.data()); }
            });
            unsubscribes.push(unsubContent);
        }
        
        function rerenderDashboard() {
            calculatePerformance();
            renderManageLotteries();
            renderManageAgents();
            renderAgentPerformance();
            renderAllParticipants();
            renderWithdrawalHistory();
            renderAdjustmentHistory();
            renderDailyRevenue();
            updateStats();
        }

        function calculatePerformance() {
            agentPerformanceData = {};
            lotteryPerformanceData = {};
            allAgents.forEach(agent => { agentPerformanceData[agent.id] = { ...agent, lotteries: {} }; });
            allLotteries.forEach(lottery => { lotteryPerformanceData[lottery.id] = { ...lottery, ticketsSold: 0, totalRevenue: 0 }; });
            allTickets.forEach(ticket => {
                const agentPerf = agentPerformanceData[ticket.agentId];
                const lotteryPerf = lotteryPerformanceData[ticket.lotteryId];
                const lottery = allLotteries.get(ticket.lotteryId);
                if (lottery) {
                    if (agentPerf) {
                        if (!agentPerf.lotteries[ticket.lotteryId]) {
                            agentPerf.lotteries[ticket.lotteryId] = { prizeName: lottery.prizeName, ticketsSold: 0, totalRevenue: 0 };
                        }
                        agentPerf.lotteries[ticket.lotteryId].ticketsSold++;
                        agentPerf.lotteries[ticket.lotteryId].totalRevenue += lottery.ticketPrice;
                    }
                    if (lotteryPerf) {
                        lotteryPerf.ticketsSold++;
                        lotteryPerf.totalRevenue += lottery.ticketPrice;
                    }
                }
            });
        }

        function renderManageLotteries() {
            const list = document.getElementById('manage-lotteries-list');
            list.innerHTML = `<table><thead><tr><th>Image</th><th>Prize</th><th>Prefix</th><th>Ticket Price</th><th>Tickets Sold</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>`;
            const tbody = list.querySelector('tbody');
            Object.values(lotteryPerformanceData).forEach(perf => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${perf.imageUrl || 'https://placehold.co/96x64/e2e8f0/64748b?text=N/A'}" alt="${perf.prizeName}" class="w-24 h-16 object-cover rounded-lg"></td>
                    <td><strong>${perf.prizeName}</strong></td>
                    <td>${perf.prefix || 'N/A'}</td>
                    <td>₹${perf.ticketPrice.toLocaleString()}</td>
                    <td>${perf.ticketsSold}</td>
                    <td><span class="status-badge ${perf.isActive ? 'status-active' : 'status-inactive'}">${perf.isActive ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn-sm btn-primary export-tickets-btn" data-id="${perf.id}">Export Tickets</button>
                        <button class="btn-sm btn-success view-participants-btn" data-id="${perf.id}">View Participants</button>
                        <button class="btn-sm btn-warning edit-lottery-btn" data-id="${perf.id}">Edit</button>
                        <button class="btn-sm ${perf.isActive ? 'btn-warning' : 'btn-success'} toggle-lottery-status-btn" data-id="${perf.id}">${perf.isActive ? 'Deactivate' : 'Activate'}</button>
                        <button class="btn-sm btn-danger delete-lottery-btn" data-id="${perf.id}">Delete</button>
                    </td>`;
                tbody.appendChild(row);
            });
        }
        
        function renderManageAgents() {
            const list = document.getElementById('manage-agents-list');
            list.innerHTML = `<table><thead><tr><th>Photo</th><th>Name</th><th>Phone</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>`;
            const tbody = list.querySelector('tbody');
            allAgents.forEach(agent => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${agent.imageUrl || 'https://placehold.co/56x56/e2e8f0/64748b?text=N/A'}" alt="${agent.name}" class="w-14 h-14 object-cover rounded-full"></td>
                    <td><strong>${agent.name}</strong></td>
                    <td>${agent.phone}</td>
                    <td><span class="status-badge ${agent.isActive ? 'status-active' : 'status-inactive'}">${agent.isActive ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn-sm btn-warning edit-agent-btn" data-id="${agent.id}">Edit</button>
                        <button class="btn-sm ${agent.isActive ? 'btn-warning' : 'btn-success'} toggle-agent-status-btn" data-id="${agent.id}">${agent.isActive ? 'Deactivate' : 'Activate'}</button>
                        <button class="btn-sm btn-danger delete-agent-btn" data-id="${agent.id}">Delete</button>
                    </td>`;
                tbody.appendChild(row);
            });
        }

        function renderAgentPerformance() {
            if (!selectedAgentId) renderAgentSelectorView();
            else if (selectedAgentId && !selectedLotteryId) renderAgentLotteriesView(selectedAgentId);
            else if (selectedAgentId && selectedLotteryId) renderAgentLotteryDetailView(selectedAgentId, selectedLotteryId);
        }

        function renderAgentSelectorView() {
            const searchTerm = agentSearchInput.value.toLowerCase().trim();
            const list = document.getElementById('agent-performance-list');
            document.getElementById('agent-performance-title').textContent = 'Agent Performance';
            document.getElementById('agent-performance-controls').style.display = 'block';
            const filteredAgents = Object.values(agentPerformanceData).filter(agent => agent.name.toLowerCase().includes(searchTerm) || agent.phone.includes(searchTerm));
            if (filteredAgents.length === 0) { list.innerHTML = `<p style="text-align:center; color: var(--text-light);">No agents found.</p>`; return; }
            list.innerHTML = `<table><thead><tr><th>Agent Name</th><th>Phone</th><th>Action</th></tr></thead><tbody>
                ${filteredAgents.map(agent => `
                    <tr>
                        <td><strong>${agent.name}</strong></td>
                        <td>${agent.phone}</td>
                        <td><button class="btn-sm btn-primary agent-select-btn" data-agent-id="${agent.id}">View Lotteries</button></td>
                    </tr>
                `).join('')}
            </tbody></table>`;
        }

        function renderAgentLotteriesView(agentId) {
            const agent = agentPerformanceData[agentId];
            const list = document.getElementById('agent-performance-list');
            document.getElementById('agent-performance-title').textContent = `Lotteries for ${agent.name}`;
            document.getElementById('agent-performance-controls').style.display = 'none';
            const agentLotteries = Object.entries(agent.lotteries);
            list.innerHTML = `<button class="btn-sm btn-primary back-btn" data-target="agent-selector">← Back to All Agents</button>
            <table><thead><tr><th>Lottery</th><th>Tickets Sold</th><th>Revenue</th><th>Action</th></tr></thead><tbody>
                ${agentLotteries.length > 0 ? agentLotteries.map(([lotteryId, lotteryData]) => `
                    <tr>
                        <td><strong>${lotteryData.prizeName}</strong></td>
                        <td>${lotteryData.ticketsSold}</td>
                        <td>₹${lotteryData.totalRevenue.toLocaleString()}</td>
                        <td><button class="btn-sm btn-primary lottery-select-btn" data-lottery-id="${lotteryId}">View Details</button></td>
                    </tr>
                `).join('') : `<tr><td colspan="4" style="text-align:center;">No lotteries for this agent.</td></tr>`}
            </tbody></table>`;
        }
        
        function renderAgentLotteryDetailView(agentId, lotteryId) {
            const agent = agentPerformanceData[agentId];
            const lotteryData = agent.lotteries[lotteryId];
            const list = document.getElementById('agent-performance-list');
             document.getElementById('agent-performance-title').textContent = `Details for ${agent.name} - ${lotteryData.prizeName}`;
             document.getElementById('agent-performance-controls').style.display = 'none';
            const overallRevenue = Object.values(agent.lotteries).reduce((sum, l) => sum + l.totalRevenue, 0);
            const rawBalance = overallRevenue - (agent.amountPaid || 0);
            const balanceCell = rawBalance < 0 ? `<td style="color:var(--success-color)"><strong>₹${Math.abs(rawBalance).toLocaleString()} (Credit)</strong></td>` : `<td><strong>₹${rawBalance.toLocaleString()}</strong></td>`;
            list.innerHTML = `<button class="btn-sm btn-primary back-btn" data-target="lottery-selector">← Back to Lotteries</button>
            <table><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody>
                <tr><td>Tickets Sold (This Lottery)</td><td>${lotteryData.ticketsSold}</td></tr>
                <tr><td>Revenue (This Lottery)</td><td>₹${lotteryData.totalRevenue.toLocaleString()}</td></tr>
                <tr><td colspan="2" style="background-color: #f8fafc; font-weight: bold;">Overall Agent Financials</td></tr>
                <tr><td>Agent's Total Revenue (All Lotteries)</td><td>₹${overallRevenue.toLocaleString()}</td></tr>
                <tr><td>Agent's Total Amount Paid</td><td>₹${(agent.amountPaid || 0).toLocaleString()}</td></tr>
                <tr><td>Agent's Overall Balance Due</td>${balanceCell}</tr>
                <tr><td>Add Payment to Agent's Account</td><td><input type="number" class="payment-input" placeholder="Amount"><button class="btn-sm btn-primary add-payment-btn" data-agent-id="${agent.id}">Add</button></td></tr>
            </tbody></table>`;
        }


        function renderAllParticipants() {
            const searchTerm = participantSearchInput.value.toLowerCase().trim();
            const list = document.getElementById('all-participants-list');
            const filteredTickets = allTickets.filter(ticket => {
                const agent = allAgents.get(ticket.agentId);
                const agentName = agent ? agent.name.toLowerCase() : '';
                return ticket.customerName.toLowerCase().includes(searchTerm) || ticket.customerPhone.includes(searchTerm) || String(ticket.serialNumber).toLowerCase().includes(searchTerm) || agentName.includes(searchTerm);
            });
            if (filteredTickets.length === 0) {
                list.innerHTML = `<p style="text-align:center; color: var(--text-light);">No participants found.</p>`;
                return;
            }
            list.innerHTML = `<table><thead><tr><th>Photo</th><th>Serial #</th><th>Customer Name</th><th>Phone</th><th>Agent</th><th>Prize</th><th>Actions</th></tr></thead><tbody>${filteredTickets.map(ticket => {
                const agent = allAgents.get(ticket.agentId);
                const lottery = allLotteries.get(ticket.lotteryId);
                return `<tr>
                    <td><img src="${ticket.customerImageUrl || 'https://placehold.co/56x56/e2e8f0/64748b?text=N/A'}" alt="Customer" class="w-14 h-14 object-cover rounded-full"></td>
                    <td><strong style="color:var(--primary-color)">${ticket.serialNumber}</strong></td>
                    <td>${ticket.customerName}</td>
                    <td>${ticket.customerPhone}</td>
                    <td>${agent ? agent.name : 'N/A'}</td>
                    <td>${lottery ? lottery.prizeName : 'N/A'}</td>
                    <td><button class="btn-sm btn-danger delete-ticket-btn" data-id="${ticket.id}">Delete</button></td>
                </tr>`;
            }).join('')}</tbody></table>`;
        }

        function renderWithdrawalHistory() {
            const list = document.getElementById('withdrawal-history-list');
            if(allWithdrawals.length === 0) { list.innerHTML = `<p style="text-align:center; color: var(--text-light);">No withdrawals recorded.</p>`; return; }
            allWithdrawals.sort((a,b) => (b.date?.toDate() || 0) - (a.date?.toDate() || 0));
            list.innerHTML = `<table><thead><tr><th>Date</th><th>Amount</th><th>Description</th><th>Actions</th></tr></thead><tbody>${allWithdrawals.map(w => `
                <tr><td>${w.date ? w.date.toDate().toLocaleDateString() : 'N/A'}</td><td><strong>₹${w.amount.toLocaleString()}</strong></td><td>${w.description}</td>
                <td><button class="btn-sm btn-warning edit-withdrawal-btn" data-id="${w.id}">Edit</button><button class="btn-sm btn-danger delete-withdrawal-btn" data-id="${w.id}">Delete</button></td></tr>`).join('')}</tbody></table>`;
        }
        
        function renderAdjustmentHistory() {
            const list = document.getElementById('adjustment-history-list');
            if(allAdjustments.length === 0) { list.innerHTML = `<p style="text-align:center; color: var(--text-light);">No adjustments recorded.</p>`; return; }
            allAdjustments.sort((a,b) => (b.date?.toDate() || 0) - (a.date?.toDate() || 0));
            list.innerHTML = `<table><thead><tr><th>Date</th><th>Amount</th><th>Description</th><th>Actions</th></tr></thead><tbody>${allAdjustments.map(adj => `
                <tr><td>${adj.date ? adj.date.toDate().toLocaleDateString() : 'N/A'}</td><td><strong style="color:${adj.amount >= 0 ? 'var(--success-color)' : 'var(--danger-color)'}">₹${adj.amount.toLocaleString()}</strong></td><td>${adj.description}</td>
                <td><button class="btn-sm btn-warning edit-adjustment-btn" data-id="${adj.id}">Edit</button><button class="btn-sm btn-danger delete-adjustment-btn" data-id="${adj.id}">Delete</button></td></tr>`).join('')}</tbody></table>`;
        }

        function renderDailyRevenue() {
            const list = document.getElementById('daily-revenue-list');
            const dailyRevenue = {};
            allTickets.forEach(ticket => {
                if (ticket.createdAt?.toDate) {
                    const date = ticket.createdAt.toDate().toISOString().split('T')[0];
                    const price = allLotteries.get(ticket.lotteryId)?.ticketPrice || 0;
                    dailyRevenue[date] = (dailyRevenue[date] || 0) + price;
                }
            });
            const sortedDays = Object.entries(dailyRevenue).sort((a, b) => b[0].localeCompare(a[0]));
            if (sortedDays.length === 0) { list.innerHTML = `<p style="text-align:center; color: var(--text-light);">No revenue recorded yet.</p>`; return; }
            list.innerHTML = `<table><thead><tr><th>Date</th><th>Total Revenue</th></tr></thead><tbody>${sortedDays.map(([date, revenue]) => `
                <tr><td><strong>${new Date(date).toLocaleDateString()}</strong></td><td><strong>₹${revenue.toLocaleString()}</strong></td></tr>`).join('')}</tbody></table>`;
        }

        function updateStats() {
            const ticketRevenue = allTickets.reduce((sum, ticket) => sum + (allLotteries.get(ticket.lotteryId)?.ticketPrice || 0), 0);
            const totalAdjustments = allAdjustments.reduce((sum, adj) => sum + adj.amount, 0);
            let totalRevenue = ticketRevenue + totalAdjustments;
            if (totalRevenue < 0) { totalRevenue = 0; }
            let totalBalanceDue = 0;
            Object.values(agentPerformanceData).forEach(perf => {
                const overallRevenue = Object.values(perf.lotteries).reduce((sum, l) => sum + l.totalRevenue, 0);
                const balance = overallRevenue - (perf.amountPaid || 0);
                if (balance > 0) { totalBalanceDue += balance; }
            });
            const totalWithdrawals = allWithdrawals.reduce((sum, w) => sum + w.amount, 0);
            const adjustedProfit = (ticketRevenue + totalAdjustments) - totalWithdrawals;
            document.getElementById('total-revenue').textContent = `₹${totalRevenue.toLocaleString()}`;
            document.getElementById('adjusted-profit').textContent = `₹${adjustedProfit.toLocaleString()}`;
            document.getElementById('balance-due').textContent = `₹${totalBalanceDue.toLocaleString()}`;
            document.getElementById('total-tickets').textContent = allTickets.length;
        }
        
        function populateCmsForm(content) {
            document.getElementById('cms-home_hero_title').value = content.home_hero_title || '';
            document.getElementById('cms-home_hero_subtitle').value = content.home_hero_subtitle || '';
            document.getElementById('cms-home_howitworks_title').value = content.home_howitworks_title || '';
            document.getElementById('cms-events_page_title').value = content.events_page_title || '';
            document.getElementById('cms-gallery_page_title').value = content.gallery_page_title || '';
            document.getElementById('cms-winners_page_title').value = content.winners_page_title || '';
        }

        function openEditLotteryModal(id) {
            const lottery = allLotteries.get(id);
            document.getElementById('edit-lottery-id').value = id;
            document.getElementById('edit-prize-name').value = lottery.prizeName;
            document.getElementById('edit-lottery-prefix').value = lottery.prefix || '';
            document.getElementById('edit-ticket-price').value = lottery.ticketPrice;
            document.getElementById('edit-draw-date').value = lottery.drawDate;
            document.getElementById('edit-draw-place').value = lottery.drawPlace || '';
            document.getElementById('edit-process-details').value = lottery.processDetails || '';
            document.getElementById('edit-lottery-image').value = '';

            const winnerSection = document.getElementById('winner-assignment-section');
            const isCompleted = new Date(lottery.drawDate) < new Date();
            if (isCompleted) {
                winnerSection.style.display = 'block';
                const winnerSelect = document.getElementById('edit-lottery-winner');
                winnerSelect.innerHTML = '<option value="">Select a Winner...</option>';
                allWinners.forEach(winner => {
                    const option = document.createElement('option');
                    option.value = winner.id;
                    option.textContent = winner.name;
                    if(lottery.winnerId === winner.id) option.selected = true;
                    winnerSelect.appendChild(option);
                });
                document.getElementById('edit-winner-ticket-id').value = lottery.winnerTicketId || '';
            } else {
                winnerSection.style.display = 'none';
            }
            document.getElementById('edit-lottery-modal').style.display = 'block';
        }

        function openEditAgentModal(id) {
            const agent = allAgents.get(id);
            document.getElementById('edit-agent-id').value = id;
            document.getElementById('edit-agent-name').value = agent.name;
            document.getElementById('edit-agent-phone').value = agent.phone;
            document.getElementById('edit-agent-password').value = '';
            document.getElementById('edit-agent-photo').value = '';
            document.getElementById('edit-agent-modal').style.display = 'block';
        }

        function openParticipantsModal(lotteryId) {
            const lottery = allLotteries.get(lotteryId);
            document.getElementById('participants-modal-title').textContent = `Participants for: ${lottery.prizeName}`;
            currentLotteryParticipants = allTickets.filter(ticket => ticket.lotteryId === lotteryId);
            participantsModalSearch.value = '';
            renderParticipantsInModal();
            document.getElementById('view-participants-modal').style.display = 'block';
        }

        function renderParticipantsInModal() {
            const list = document.getElementById('participants-modal-list');
            const searchTerm = participantsModalSearch.value.toLowerCase().trim();
            const filtered = currentLotteryParticipants.filter(ticket => {
                 const agent = allAgents.get(ticket.agentId);
                 const agentName = agent ? agent.name.toLowerCase() : '';
                 return ticket.customerName.toLowerCase().includes(searchTerm) || ticket.customerPhone.includes(searchTerm) || String(ticket.serialNumber).toLowerCase().includes(searchTerm) || agentName.includes(searchTerm);
            });
            if(filtered.length === 0) { list.innerHTML = `<p style="text-align:center; color: var(--text-light);">No participants found.</p>`; return; }
            list.innerHTML = `<table><thead><tr><th>Serial #</th><th>Customer Name</th><th>Phone</th><th>Agent</th></tr></thead><tbody>${filtered.map(ticket => {
                const agent = allAgents.get(ticket.agentId);
                return `<tr><td><strong>${ticket.serialNumber}</strong></td><td>${ticket.customerName}</td><td>${ticket.customerPhone}</td><td>${agent ? agent.name : 'N/A'}</td></tr>`
            }).join('')}</tbody></table>`;
        }

        function openEditWithdrawalModal(id) {
            const withdrawal = allWithdrawals.find(w => w.id === id);
            document.getElementById('edit-withdrawal-id').value = id;
            document.getElementById('edit-withdrawal-amount').value = withdrawal.amount;
            document.getElementById('edit-withdrawal-desc').value = withdrawal.description;
            document.getElementById('edit-withdrawal-modal').style.display = 'block';
        }
        
        function openEditAdjustmentModal(id) {
            const adj = allAdjustments.find(a => a.id === id);
            document.getElementById('edit-adjustment-id').value = id;
            document.getElementById('edit-adjustment-amount').value = adj.amount;
            document.getElementById('edit-adjustment-desc').value = adj.description;
            document.getElementById('edit-adjustment-modal').style.display = 'block';
        }

        function openExportTicketsModal(lotteryId) {
            const lottery = allLotteries.get(lotteryId);
            const grid = document.getElementById('printable-tickets-grid');
            document.getElementById('export-tickets-modal-title').textContent = `Tickets for ${lottery.prizeName}`;
            
            const ticketsForLottery = allTickets.filter(t => t.lotteryId === lotteryId);
            ticketsForLottery.sort((a,b) => {
                const numA = parseInt((a.serialNumber || '0-0').split('-')[1]);
                const numB = parseInt((b.serialNumber || '0-0').split('-')[1]);
                return numA - numB;
            });

            grid.innerHTML = ticketsForLottery.map(t => `<div class="ticket-stub">${t.serialNumber}</div>`).join('');
            document.getElementById('export-tickets-modal').style.display = 'block';
            document.getElementById('print-tickets-pdf-btn').dataset.lotteryName = lottery.prizeName;
        }

        let confirmCallback = null;
        function showConfirmationModal(message, onConfirm) {
            document.getElementById('confirmation-modal-message').textContent = message;
            confirmationModal.style.display = 'block';
            confirmCallback = onConfirm;
        }

        document.getElementById('confirmation-modal-cancel-btn').addEventListener('click', () => { confirmationModal.style.display = 'none'; confirmCallback = null; });
        document.getElementById('confirmation-modal-confirm-btn').addEventListener('click', () => { if(confirmCallback) { confirmCallback(); } confirmationModal.style.display = 'none'; confirmCallback = null; });

        document.addEventListener('click', async (e) => {
            if (e.target.matches('.agent-select-btn')) { selectedAgentId = e.target.dataset.agentId; renderAgentPerformance(); }
            if (e.target.matches('.lottery-select-btn')) { selectedLotteryId = e.target.dataset.lotteryId; renderAgentPerformance(); }
            if (e.target.matches('.back-btn')) { if (e.target.dataset.target === 'agent-selector') { selectedAgentId = null; selectedLotteryId = null; } else if (e.target.dataset.target === 'lottery-selector') { selectedLotteryId = null; } renderAgentPerformance(); }
            if (e.target.matches('.edit-lottery-btn')) openEditLotteryModal(e.target.dataset.id);
            if (e.target.matches('.edit-agent-btn')) openEditAgentModal(e.target.dataset.id);
            if (e.target.matches('.view-participants-btn')) openParticipantsModal(e.target.dataset.id);
            if (e.target.matches('.export-tickets-btn')) openExportTicketsModal(e.target.dataset.id);
            if (e.target.matches('.edit-withdrawal-btn')) openEditWithdrawalModal(e.target.dataset.id);
            if (e.target.matches('.edit-adjustment-btn')) openEditAdjustmentModal(e.target.dataset.id);
            if (e.target.matches('.delete-withdrawal-btn')) { showConfirmationModal('Are you sure you want to delete this withdrawal?', () => deleteDoc(doc(db, "withdrawals", e.target.dataset.id))); }
            if (e.target.matches('.delete-adjustment-btn')) { showConfirmationModal('Are you sure you want to delete this adjustment?', () => deleteDoc(doc(db, "adjustments", e.target.dataset.id))); }
            if (e.target.matches('.delete-ticket-btn')) { const ticket = allTickets.find(t => t.id === e.target.dataset.id); showConfirmationModal(`Are you sure you want to delete ticket ${ticket.serialNumber}?`, () => deleteDoc(doc(db, "tickets", e.target.dataset.id))); }
            if (e.target.matches('.delete-lottery-btn')) { showConfirmationModal('Are you sure you want to PERMANENTLY delete this lottery and all associated tickets?', () => { allTickets.filter(t => t.lotteryId === e.target.dataset.id).forEach(t => deleteDoc(doc(db, "tickets", t.id))); deleteDoc(doc(db, "lotteries", e.target.dataset.id)); }); }
            if (e.target.matches('.delete-agent-btn')) { showConfirmationModal('Are you sure you want to PERMANENTLY delete this agent? This cannot be undone.', () => deleteDoc(doc(db, "agents", e.target.dataset.id))); }
            if (e.target.matches('.toggle-lottery-status-btn')) { const id = e.target.dataset.id; const lottery = allLotteries.get(id); const action = lottery.isActive ? 'Deactivate' : 'Activate'; showConfirmationModal(`Are you sure you want to ${action} this lottery?`, () => updateDoc(doc(db, "lotteries", id), { isActive: !lottery.isActive })); }
            if (e.target.matches('.toggle-agent-status-btn')) { const id = e.target.dataset.id; const agent = allAgents.get(id); const action = agent.isActive ? 'Deactivate' : 'Activate'; showConfirmationModal(`Are you sure you want to ${action} this agent?`, () => updateDoc(doc(db, "agents", id), { isActive: !agent.isActive })); }
            if (e.target.matches('.add-payment-btn')) { const agentId = e.target.dataset.agentId; const input = e.target.previousElementSibling; const newPaymentAmount = Number(input.value); if (isNaN(newPaymentAmount) || newPaymentAmount <= 0) { alert("Please enter a valid positive amount."); return; } const agentData = allAgents.get(agentId); const currentAmountPaid = agentData.amountPaid || 0; const newTotalPaid = currentAmountPaid + newPaymentAmount; e.target.textContent = '...'; e.target.disabled = true; await updateDoc(doc(db, "agents", agentId), { amountPaid: newTotalPaid }); input.value = ''; }
            if (e.target.matches('.close-btn')) { document.getElementById(e.target.dataset.modal).style.display = 'none'; }
            if (e.target.matches('.export-pdf-btn')) {
                const { jsPDF } = window.jspdf;
                const tableId = e.target.dataset.table;
                const title = e.target.dataset.title;
                const table = document.querySelector(`#${tableId} table`);
                if(table) {
                    const doc = new jsPDF();
                    doc.text(title, 14, 15);
                    doc.autoTable({ html: table, startY: 22 });
                    doc.save(`${title.replace(/\s+/g, '_')}.pdf`);
                } else {
                    alert('No data to export for this section.');
                }
            }
        });
        
        document.getElementById('print-tickets-pdf-btn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const lotteryName = document.getElementById('print-tickets-pdf-btn').dataset.lotteryName;
            const doc = new jsPDF();
            doc.text(`Tickets for: ${lotteryName}`, 14, 15);
            
            const stubs = Array.from(document.querySelectorAll('.ticket-stub')).map(stub => [stub.textContent]);

            doc.autoTable({
                startY: 22,
                body: stubs,
                theme: 'plain',
                styles: { halign: 'center', cellPadding: 4, fontSize: 12, lineWidth: 0.5, lineColor: [0,0,0] }
            });
            doc.save(`${lotteryName.replace(/\s+/g, '_')}_Tickets.pdf`);
        });

        document.getElementById('login-form').addEventListener('submit', async(e) => {
            e.preventDefault();
            const loginMessage = document.getElementById('login-message');
            const q = query(collection(db, "admins"), where("username", "==", document.getElementById('admin-username').value), where("password", "==", document.getElementById('admin-password').value));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                loginMessage.textContent = 'Invalid admin credentials.';
                loginMessage.className = 'message error';
                loginMessage.style.display = 'block';
            } else {
                sessionStorage.setItem('isAdminLoggedIn', 'true');
                loginView.style.display = 'none';
                adminPanelView.style.display = 'block';
                setupRealtimeListeners();
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
             sessionStorage.removeItem('isAdminLoggedIn');
             unsubscribes.forEach(unsub => unsub());
             window.location.reload();
        });

        document.getElementById('create-lottery-form').addEventListener('submit', async (e) => { e.preventDefault(); const s = e.target.querySelector('button'); s.disabled=true; s.textContent='...'; const i = document.getElementById('lottery-image').files[0]; if(!i){alert("Please select an image.");s.disabled=false;s.textContent='Create Lottery';return;} const u = await uploadImageToCloudinary(i); if(u){await addDoc(collection(db, "lotteries"), { prizeName: document.getElementById('prize-name').value, prefix: document.getElementById('lottery-prefix').value.toUpperCase(), ticketPrice: Number(document.getElementById('ticket-price').value), drawDate: document.getElementById('draw-date').value, drawPlace: document.getElementById('draw-place').value, processDetails: document.getElementById('process-details').value, imageUrl:u, isActive: true, createdAt: serverTimestamp() }); e.target.reset();} s.disabled=false;s.textContent='Create Lottery'; });
        document.getElementById('create-agent-form').addEventListener('submit', async (e) => { e.preventDefault(); const s = e.target.querySelector('button'); s.disabled = true; s.textContent = '...'; const i = document.getElementById('agent-photo').files[0]; if (!i) { alert("Please select an image."); s.disabled = false; s.textContent = 'Create Agent'; return; } const u = await uploadImageToCloudinary(i); if(u){await addDoc(collection(db, "agents"), { name: document.getElementById('agent-name').value, phone: document.getElementById('agent-phone').value, password: document.getElementById('agent-password').value, imageUrl: u, isActive: true, amountPaid: 0 }); e.target.reset();} s.disabled=false; s.textContent='Create Agent'; });
        document.getElementById('edit-lottery-form').addEventListener('submit', async (e) => { e.preventDefault(); const s=e.target.querySelector('button'); s.disabled=true;s.textContent='...'; const id = document.getElementById('edit-lottery-id').value; const i = document.getElementById('edit-lottery-image').files[0]; let u=allLotteries.get(id).imageUrl; if(i){const n=await uploadImageToCloudinary(i);if(n)u=n;} const d={prizeName:document.getElementById('edit-prize-name').value,prefix:document.getElementById('edit-lottery-prefix').value.toUpperCase(),ticketPrice:Number(document.getElementById('edit-ticket-price').value),drawDate:document.getElementById('edit-draw-date').value, drawPlace: document.getElementById('edit-draw-place').value, processDetails: document.getElementById('edit-process-details').value, imageUrl:u}; const winnerId = document.getElementById('edit-lottery-winner').value; const winnerTicketId = document.getElementById('edit-winner-ticket-id').value; if(winnerId){const winnerData=allWinners.find(w=>w.id===winnerId); d.winnerId=winnerId; d.winnerName=winnerData.name; d.winnerImageUrl=winnerData.imageUrl;} if(winnerTicketId){d.winnerTicketId=winnerTicketId;} await updateDoc(doc(db,"lotteries",id),d); document.getElementById('edit-lottery-modal').style.display='none'; s.disabled=false;s.textContent='Save Changes'; });
        document.getElementById('edit-agent-form').addEventListener('submit', async (e) => { e.preventDefault(); const s=e.target.querySelector('button'); s.disabled=true; s.textContent='...'; const id = document.getElementById('edit-agent-id').value; const password = document.getElementById('edit-agent-password').value; const i = document.getElementById('edit-agent-photo').files[0]; let u = allAgents.get(id).imageUrl; if(i){const n=await uploadImageToCloudinary(i);if(n)u=n;} const d = { name: document.getElementById('edit-agent-name').value, phone: document.getElementById('edit-agent-phone').value, imageUrl: u }; if (password) { d.password = password; } await updateDoc(doc(db, "agents", id), d); document.getElementById('edit-agent-modal').style.display = 'none'; s.disabled=false; s.textContent='Save Changes';});
        document.getElementById('withdrawal-form').addEventListener('submit', async (e) => { e.preventDefault(); await addDoc(collection(db, "withdrawals"), { amount: Number(document.getElementById('withdrawal-amount').value), description: document.getElementById('withdrawal-desc').value, date: serverTimestamp() }); e.target.reset(); });
        document.getElementById('adjustment-form').addEventListener('submit', async (e) => { e.preventDefault(); await addDoc(collection(db, "adjustments"), { amount: Number(document.getElementById('adjustment-amount').value), description: document.getElementById('adjustment-desc').value, date: serverTimestamp() }); e.target.reset(); });
        document.getElementById('edit-withdrawal-form').addEventListener('submit', async (e) => { e.preventDefault(); await updateDoc(doc(db, "withdrawals", document.getElementById('edit-withdrawal-id').value), { amount: Number(document.getElementById('edit-withdrawal-amount').value), description: document.getElementById('edit-withdrawal-desc').value }); document.getElementById('edit-withdrawal-modal').style.display = 'none'; });
        document.getElementById('edit-adjustment-form').addEventListener('submit', async (e) => { e.preventDefault(); await updateDoc(doc(db, "adjustments", document.getElementById('edit-adjustment-id').value), { amount: Number(document.getElementById('edit-adjustment-amount').value), description: document.getElementById('edit-adjustment-desc').value }); document.getElementById('edit-adjustment-modal').style.display = 'none'; });
        document.getElementById('cms-form').addEventListener('submit', async (e) => { e.preventDefault(); const s = e.target.querySelector('button'); s.disabled = true; s.textContent = 'Saving...'; const d = { home_hero_title: document.getElementById('cms-home_hero_title').value, home_hero_subtitle: document.getElementById('cms-home_hero_subtitle').value, home_howitworks_title: document.getElementById('cms-home_howitworks_title').value, events_page_title: document.getElementById('cms-events_page_title').value, gallery_page_title: document.getElementById('cms-gallery_page_title').value, winners_page_title: document.getElementById('cms-winners_page_title').value, }; try { await setDoc(doc(db, "site_content", "live_data"), d); showMessage('Website content saved successfully!', 'success'); } catch (error) { console.error("Error saving CMS data: ", error); showMessage('Failed to save content.', 'error'); } finally { s.disabled = false; s.textContent = 'Save Website Content'; } });

        agentSearchInput.addEventListener('input', renderAgentPerformance);
        participantSearchInput.addEventListener('input', renderAllParticipants);
        participantsModalSearch.addEventListener('input', renderParticipantsInModal);
        
        function revealElements() {
            const reveals = document.querySelectorAll('.reveal');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });
            reveals.forEach((el, index) => {
                el.style.transitionDelay = `${index * 100}ms`;
                observer.observe(el);
            });
        }
        
        if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
            loginView.style.display = 'none';
            adminPanelView.style.display = 'block';
            setupRealtimeListeners();
        }
    </script>
</body>
</html>

